{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load static %}

{% block body %}

    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/css/select2.min.css" rel="stylesheet"/>
    <link href="{% static 'css/select2-bootstrap4.min.css' %}" rel="stylesheet"/>

    <style>
        .lds-ellipsis {
            display: inline-block;
            position: relative;
            width: 64px;
            height: 64px;
        }

        .lds-ellipsis div {
            position: absolute;
            top: 27px;
            width: 11px;
            height: 11px;
            border-radius: 50%;
            background: #921bb3;
            animation-timing-function: cubic-bezier(0, 1, 1, 0);
        }

        .lds-ellipsis div:nth-child(1) {
            left: 6px;
            animation: lds-ellipsis1 0.6s infinite;
        }

        .lds-ellipsis div:nth-child(2) {
            left: 6px;
            animation: lds-ellipsis2 0.6s infinite;
        }

        .lds-ellipsis div:nth-child(3) {
            left: 26px;
            animation: lds-ellipsis2 0.6s infinite;
        }

        .lds-ellipsis div:nth-child(4) {
            left: 45px;
            animation: lds-ellipsis3 0.6s infinite;
        }

        @keyframes lds-ellipsis1 {
            0% {
                transform: scale(0);
            }
            100% {
                transform: scale(1);
            }
        }

        @keyframes lds-ellipsis3 {
            0% {
                transform: scale(1);
            }
            100% {
                transform: scale(0);
            }
        }

        @keyframes lds-ellipsis2 {
            0% {
                transform: translate(0, 0);
            }
            100% {
                transform: translate(19px, 0);
            }
        }

        .upload-image svg {
            width: 55px;
            height: 55px;
        }

        .upload-image {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 260px;
            height: 260px;
            background-color: rgba(0, 0, 0, 0.06);
            color: #4b4b4b;
            border-radius: 5px;
            overflow: hidden;
            border: 2px dashed #cdcdcd;
        }
    </style>

    <main id="pageWrapper">
        <div class="banner bg-song"></div>
        <div class="main-container">
            <div class="row section">
                <div class="col-xl-10 col-md-12 mx-auto">
                    <div class="card">
                        <form action="{% url 'upload' %}" method="post" enctype="multipart/form-data">    
                          {% csrf_token %}
                          <fieldset class="form-group">
                              <legend class="border-bottom mb-4">Song Info</legend>
                              {{ sform|crispy }}
                          </fieldset>
                          <div class="form-group">
                              <button class="btn btn-outline-info" type="submit">submit</button>
                          </div>
                      </form>
                    </div>
                </div>
            </div>
        </div>
    </main>

{% endblock %}

{% block js %}

    <script src="{% static 'musicapp/js/scripts.bundle.js' %}"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.12/jquery-ui.min.js" type="text/javascript"
        charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tag-it/2.0/js/tag-it.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.js"></script>
<link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/js/select2.min.js"></script>
    <script type="text/javascript">

        let select2 = $(".select2");

        select2.select2({
            placeholder: "Select artists",
            theme: 'bootstrap4',
            width: 'style',
            tags: true,
        });

        select2.on('select2:select', function (e) {
            let elm = e.params.data.element;
            $elm = jQuery(elm);
            $t = jQuery(this);
            $t.append($elm);
            $t.trigger('change.select2');
        });

        $('#songImage').change(function () {
            if (this.files && this.files[0]) {
                let reader = new FileReader();

                reader.onload = function (e) {
                    $('.upload-image svg').remove();
                    $('.upload-image img').remove();
                    $('.upload-image').prepend('<img src="' + e.target.result + '" alt="" style="width: 100%"/>');
                };
                reader.readAsDataURL(this.files[0]);
            }
        });

        function _(el) {
            return document.getElementById(el);
        }

        let form = $('form');

        form.submit(function (e) {
            e.preventDefault();

            $(this).find('button[type=submit]').attr('disabled', true);
            $(this).find('.lds-ellipsis').css('display', "block");

            $.ajax({
                url: $(this).attr('action'),
                type: 'post',
                datatype: 'json',
                data: new FormData(this),
                contentType: false,
                processData: false,
                success: function (data) {
                    form.find('button[type=submit]').attr('disabled', false);
                    form.find('.lds-ellipsis').css('display', "none");

                    if (data.status === 'validation' || data.status === 'error') {
                        $.each(data.message, function (index, message) {
                            toastr.warning(message);
                        });
                        toastr.options = {
                            "positionClass": "toast-bottom-right",
                            "timeOut ": 30,
                        };
                    } else if (data.status === true) {

                        toastr.options = {
                            "positionClass": "toast-bottom-right",
                        };
                        toastr.success(data.message);

                        setTimeout(function () {
                            window.location.href = data.redirect;
                        }, 2000);
                    }
                }, error: function (err) {
                    console.log(err.data);
                    form.find('.lds-ellipsis').css('display', "none");
                    form.find('button[type=submit]').attr('disabled', false);
                }
            });
        })
    </script>

{% endblock %}